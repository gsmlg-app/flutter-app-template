default_platform(:ios)

platform :ios do
  desc "Sync certificates and provisioning profiles"
  lane :sync_certificates do
    match(
      type: "appstore",
      readonly: is_ci,
      git_basic_authorization: is_ci ? Base64.strict_encode64(ENV["MATCH_GIT_BASIC_AUTH"] || "") : nil,
      keychain_name: is_ci ? "fastlane_keychain" : "login.keychain",
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
    )
  end

  desc "Build release IPA"
  lane :build do |options|
    version_name = options[:version_name] || "1.0.0"
    version_code = options[:version_code] || "1"

    # Setup keychain on CI
    if is_ci
      create_keychain(
        name: "fastlane_keychain",
        password: ENV["KEYCHAIN_PASSWORD"],
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false
      )
    end

    # Sync certificates
    match(
      type: "appstore",
      readonly: true,
      git_basic_authorization: is_ci ? Base64.strict_encode64(ENV["MATCH_GIT_BASIC_AUTH"] || "") : nil,
      keychain_name: is_ci ? "fastlane_keychain" : "login.keychain",
      keychain_password: ENV["KEYCHAIN_PASSWORD"]
    )

    # Disable automatic signing and use Match profiles
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "Runner.xcodeproj",
      team_id: CredentialsManager::AppfileConfig.try_fetch_value(:team_id),
      bundle_identifier: "dev.gsmlg.flutterAppTemplate",
      profile_name: ENV["sigh_dev.gsmlg.flutterAppTemplate_appstore_profile-name"] || "match AppStore dev.gsmlg.flutterAppTemplate",
      code_sign_identity: "iPhone Distribution"
    )

    # Build Flutter app without codesigning (Xcode will sign it)
    Dir.chdir("../..") do
      sh("flutter build ios --release --build-name=#{version_name} --build-number=#{version_code} --no-codesign")
    end

    # Build and sign the IPA
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "../build/ios/ipa",
      output_name: "app.ipa",
      export_options: {
        provisioningProfiles: {
          "dev.gsmlg.flutterAppTemplate" => ENV["sigh_dev.gsmlg.flutterAppTemplate_appstore_profile-name"] || "match AppStore dev.gsmlg.flutterAppTemplate"
        }
      }
    )
  end

  desc "Deploy to TestFlight"
  lane :deploy_testflight do |options|
    version_name = options[:version_name] || "1.0.0"
    version_code = options[:version_code] || "1"

    build(version_name: version_name, version_code: version_code)

    # Use App Store Connect API key
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_KEY_CONTENT"],
      is_key_content_base64: true
    )

    upload_to_testflight(
      api_key: api_key,
      ipa: "../build/ios/ipa/app.ipa",
      skip_waiting_for_build_processing: true,
      distribute_external: false
    )
  end

  desc "Cleanup CI keychain"
  lane :cleanup do
    if is_ci
      delete_keychain(name: "fastlane_keychain") if File.exist?(File.expand_path("~/Library/Keychains/fastlane_keychain-db"))
    end
  end

  error do |lane, exception|
    cleanup
  end
end
