name: Brick Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'bricks/**'
      - 'tool/brick_tests/**'
      - '.github/workflows/brick-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'bricks/**'
      - 'tool/brick_tests/**'
      - '.github/workflows/brick-tests.yml'
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'structure'
          - 'generation'
          - 'integration'
      run_integration:
        description: 'Run integration tests in real project'
        required: false
        default: false
        type: boolean

jobs:
  test-bricks:
    name: Brick Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - uses: flutter-actions/setup-flutter@v4

      - name: Cache dependencies
        uses: actions/cache@v5
        with:
          path: |
            ~/.pub-cache
            .dart_tool
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: ${{ runner.os }}-pub-

      - name: Install tools
        run: |
          dart pub global activate mason_cli
          dart pub global activate melos

      - name: Initialize project
        run: |
          melos bootstrap
          mason get

      - name: Validate brick structure
        if: inputs.test_type == 'all' || inputs.test_type == 'structure' || inputs.test_type == ''
        run: |
          echo "=== Validating Brick Structure ==="

          for brick_dir in bricks/*/; do
            if [ -d "$brick_dir" ]; then
              brick_name=$(basename "$brick_dir")
              echo "Validating $brick_name..."

              if [ ! -f "$brick_dir/brick.yaml" ]; then
                echo "  Missing brick.yaml in $brick_name (may be hooks-only)"
                continue
              fi

              if [ -d "$brick_dir/__brick__" ]; then
                echo "  $brick_name has standard brick structure"
              else
                echo "  $brick_name has non-standard structure (may be hooks-only)"
              fi

              if [ -f "$brick_dir/brick.yaml" ]; then
                if ! grep -q "^name:" "$brick_dir/brick.yaml" || \
                   ! grep -q "^description:" "$brick_dir/brick.yaml" || \
                   ! grep -q "^version:" "$brick_dir/brick.yaml"; then
                  echo "  Missing required fields in $brick_name/brick.yaml"
                  exit 1
                fi
                echo "  $brick_name/brick.yaml has required fields"
              fi
            fi
          done

          echo "Structure validation completed"

      - name: Test brick generation
        if: inputs.test_type == 'all' || inputs.test_type == 'generation' || inputs.test_type == ''
        run: |
          echo "=== Testing Brick Generation ==="

          TEMP_DIR=$(mktemp -d)
          echo "Using temp directory: $TEMP_DIR"

          # Test api_client brick
          echo "Testing api_client brick..."
          if mason make api_client -o "$TEMP_DIR/test_api_client" --package_name=test_api_client 2>/dev/null; then
            echo "  api_client generation succeeded"
          else
            echo "  api_client generation failed (may need additional params)"
          fi

          # Test simple_bloc brick
          echo "Testing simple_bloc brick..."
          if mason make simple_bloc -o "$TEMP_DIR/test_bloc" --name=test_bloc 2>/dev/null; then
            echo "  simple_bloc generation succeeded"
          else
            echo "  simple_bloc generation failed"
          fi

          # Test repository brick
          echo "Testing repository brick..."
          if mason make repository -o "$TEMP_DIR/test_repo" --name=test_repo 2>/dev/null; then
            echo "  repository generation succeeded"
          else
            echo "  repository generation failed"
          fi

          # Cleanup
          rm -rf "$TEMP_DIR"
          echo "Generation testing completed"

      - name: Run brick unit tests
        if: inputs.test_type == 'all' || inputs.test_type == ''
        run: |
          echo "=== Running Brick Unit Tests ==="
          if [ -d "tool/brick_tests" ]; then
            cd tool/brick_tests
            dart pub get
            if [ -f "all_bricks_test.dart" ]; then
              dart run all_bricks_test.dart || echo "Some tests may have failed"
            fi
            cd "$GITHUB_WORKSPACE"
          else
            echo "No brick_tests directory found, skipping unit tests"
          fi

      - name: Integration test in real project
        if: inputs.run_integration == true || inputs.test_type == 'integration'
        run: |
          echo "=== Integration Testing ==="

          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"

          # Create minimal Flutter project
          flutter create --empty test_app
          cd test_app

          # Copy mason.yaml from source
          cp "$GITHUB_WORKSPACE/mason.yaml" .
          mason get

          # Test screen brick in Flutter context
          mkdir -p lib/screens
          if mason make screen -o lib/screens --name TestScreen --folder test 2>/dev/null; then
            echo "  Screen brick generation in Flutter project succeeded"
            flutter pub get || true
            flutter analyze || echo "  Analysis had warnings (may be expected)"
          else
            echo "  Screen brick generation failed"
          fi

          # Cleanup
          cd "$GITHUB_WORKSPACE"
          rm -rf "$TEMP_DIR"
          echo "Integration testing completed"

      - name: Generate summary
        run: |
          echo "=========================================="
          echo "BRICK TEST SUMMARY"
          echo "=========================================="
          echo ""
          echo "Test Type: ${{ inputs.test_type || 'all' }}"
          echo "Integration Tests: ${{ inputs.run_integration || 'false' }}"
          echo ""
          echo "Total bricks: $(find bricks -maxdepth 1 -type d | wc -l)"
          echo "Bricks with brick.yaml: $(find bricks -name 'brick.yaml' | wc -l)"
          echo ""
          echo "Brick testing completed!"
          echo "=========================================="
